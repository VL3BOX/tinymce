tinymce.PluginManager.add("videox", function (editor, url) {
    var openDialog = function () {
        return editor.windowManager.open({
            title: "æ’å…¥BV",
            body: {
                type: "panel",
                items: [
                    {
                        type: "input",
                        initValue: "è¯·è¾“å…¥BVå·",
                        name: "videox",
                        label: `<a style="margin-bottom: 10px;display: block;color: #0366D6;font-weight: bold;" href="/tool/686/" target="_blank">ğŸ’™ ç‚¹å‡»æŸ¥çœ‹å¦‚ä½•è·å–è§†é¢‘åœ°å€</a>`,
                    },
                ],
            },
            buttons: [
                {
                    type: "cancel",
                    text: "å–æ¶ˆ",
                },
                {
                    type: "submit",
                    text: "æ’å…¥",
                    primary: true,
                },
            ],
            onSubmit: function (api) {
                var data = api.getData();
                let videox = data.videox;
                if (videox.startsWith("https://www.bilibili.com/video/")) {
                    const regex = /https:\/\/www.bilibili.com\/video\/(BV\w+)/;
                    const found = videox.match(regex);
                    if (found) {
                        videox = found[1];
                    }
                }
                if (!videox) {
                    alert("è¯·è¾“å…¥BVå·");
                    return;
                }
                // å°†è¾“å…¥æ¡†å†…å®¹æ’å…¥åˆ°å†…å®¹åŒºå…‰æ ‡ä½ç½®
                editor.insertContent(`<iframe class="w-player-bilibili" src="//player.bilibili.com/player.html?bvid=${videox}" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe>`);
                api.close();
            },
        });
    };

    // æ³¨å†Œä¸€ä¸ªå·¥å…·æ æŒ‰é’®åç§°
    editor.ui.registry.addButton("videox", {
        icon : 'videox',
        tooltip: "æ’å…¥è§†é¢‘",
        // text: 'æ’å…¥è§†é¢‘',
        onAction: function () {
            openDialog();
        },
    });

    // æ³¨å†Œä¸€ä¸ªèœå•é¡¹åç§° menu/menubar
    // editor.ui.registry.addMenuItem("videox", {
    //     text: "Exampleèœå•å",
    //     onAction: function () {
    //         openDialog();
    //     },
    // });

    return {
        getMetadata: function () {
            return {
                //æ’ä»¶åå’Œé“¾æ¥ä¼šæ˜¾ç¤ºåœ¨â€œå¸®åŠ©â€â†’â€œæ’ä»¶â€â†’â€œå·²å®‰è£…çš„æ’ä»¶â€ä¸­
                name: "videox", //æ’ä»¶åç§°
                url: "https://github.com/JX3BOX", //ä½œè€…ç½‘å€
            };
        },
    };
});
